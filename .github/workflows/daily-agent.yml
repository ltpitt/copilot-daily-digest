name: Daily Copilot Digest

# Creates an issue daily for Copilot coding agent to process.
# The agent will run copilot-setup-steps.yml to fetch fresh data before working.
on:
  workflow_dispatch:       # Allow manual triggering
  schedule:
    - cron: '0 7 * * 5'     # 5 = Friday (UTC)

permissions:
  issues: write            # Required to create issues

jobs:
  create-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Create Issue for Copilot Coding Agent
        id: create-issue
        env:
          GH_TOKEN: ${{ secrets.MY_REPOSITORY_SECRET_PAT }}
        run: |
          BODY="Daily Content Update - Generate content from fresh data and update all files in content/ directory. See .github/copilot-instructions.md for workflow details."
          ISSUE_URL=$(gh issue create \
            --repo "${{ github.repository }}" \
            --title "Content Update - $(date +'%Y-%m-%d')" \
            --body "$BODY")
          
          echo "Created issue: ${ISSUE_URL}"
          
          # Extract issue number from URL
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oP '(?<=/issues/)\d+$')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
      
      - name: Assign Issue to Copilot
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MY_REPOSITORY_SECRET_PAT }}
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.issue_number }};
            const assignee = 'copilot-swe-agent[bot]';
            
            try {
              console.log(`Attempting to assign issue #${issueNumber} to ${assignee}...`);
              
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                assignees: [assignee]
              });
              
              console.log(`✓ Successfully assigned ${assignee} to issue #${issueNumber}`);
            } catch (error) {
              console.error(`✗ Failed to assign ${assignee} to issue #${issueNumber}`);
              console.error(`Error: ${error.message}`);
              
              // Log error but don't fail the workflow
              // The issue was created successfully, assignment is optional
              core.warning(`Assignment failed: ${error.message}`);
            }
