name: Daily Copilot Digest

on:
  schedule:
    - cron: '14 23 * * *'  # Daily at 1 PM UTC
  workflow_dispatch:     # Allows manual triggering

permissions:
  contents: write        # Required to push changes
  pull-requests: write   # Required for copilot agent
  issues: write          # Required to create issues

jobs:
  fetch-and-detect:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Fetch all content sources
      - name: Fetch GitHub Docs
        run: python scraper/fetch_docs.py
      
      - name: Fetch GitHub Blog (RSS)
        run: python scraper/fetch_blog.py
      
      - name: Fetch YouTube Videos (RSS)
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: python scraper/fetch_youtube.py
      
      # Detect changes
      - name: Detect Changes
        id: changes
        run: |
          python scraper/detect_changes.py > changes.txt
          cat changes.txt
          
          # Check if there are changes
          if grep -q '"has_changes": true' data/changes-summary.json; then
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
          else
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          fi
      
      # Commit data files
      - name: Commit Data Files
        if: steps.changes.outputs.HAS_CHANGES == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git commit -m "chore: update scraped data [$(date +'%Y-%m-%d')]"
          git push
      
      # Trigger Publisher Agent (only if changes detected)
      - name: Create Issue for Publisher Agent
        if: steps.changes.outputs.HAS_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read change summary
          SUMMARY=$(cat data/changes-summary.json | jq -r '.summary_text')
          
          # Create issue for Publisher agent
          gh issue create \
            --title "üì∞ Content Update Required - $(date +'%Y-%m-%d')" \
            --body "## Changes Detected

          $SUMMARY

          ---

          @copilot Please synthesize curated, actionable content that helps engineers stay current with GitHub Copilot Coding Agent.

          ### Data Sources Available
          - **Documentation**: \`data/docs/*.md\` (14 files) - Official GitHub Copilot docs
          - **Blog Posts**: \`data/blog/*.json\` (19 files) - Full HTML content with tutorials, best practices, announcements
          - **Videos**: \`data/videos/*.json\` (6 files) - Curated Copilot/AI videos from GitHub channel
          - **Change Detection**: \`data/changes-summary.json\` - What changed since last scrape (with diff summaries)
          - **Version History**: \`data/metadata.json\` - \`doc_versions[].history[]\` tracks all changes with timestamps

          ### Task: Generate 2 Content Files

          #### 1. \`content/README.md\` - Engineer's Daily Companion
          
          **Goal**: Constantly-updated getting started guide (like STARTER-KIT.md)
          
          Structure:
          \`\`\`markdown
          # GitHub Copilot: Your Daily Companion
          
          > Last updated: [DATE] | üì∞ [N] updates this week
          
          ## üöÄ Quick Start in 5 Minutes
          [Progressive steps for new users]
          
          ## üì∞ What's New This Week
          [TOP 3-5 significant changes only - curate from changes-summary.json and blog posts]
          
          ## üí° Best Practices
          [3-5 actionable tips extracted from blog post HTML content]
          
          ## üé• Featured Videos
          [1-2 most relevant to recent updates]
          
          ---
          **Need more?** [Complete Reference](REFERENCE.md) | [Official Docs](https://docs.github.com/copilot)
          \`\`\`

          **AI Instructions for What's New**:
          - Parse \`data/blog/*.json\` ‚Üí look for \`published\` in last 7 days
          - Check blog post \`content\` field for keywords: \"new feature\", \"announcing\", \"now available\"
          - Prioritize: Blog posts > Doc changes with \`added_lines > 50\` > Minor updates
          - Format: **[Feature]** (date) + one-sentence + key benefit + 2 links (try it, learn more)
          
          **AI Instructions for Best Practices**:
          - Parse \`data/blog/*.json\` ‚Üí \`content\` field (HTML)
          - Look for: \"best practice\", \"tip:\", \"prompt pattern:\", \"try this:\", code examples
          - Extract actionable advice with concrete examples
          - Format: **[Tip title]**: [description with example] ‚Üí Source: [blog post](link)

          #### 2. \`content/REFERENCE.md\` - Complete Reference

          **Goal**: Comprehensive documentation for deep dives
          
          Structure:
          \`\`\`markdown
          # GitHub Copilot Complete Reference
          
          ## Slash Commands
          [Extract from data/docs/copilot-chat.md]
          
          ## Chat Variables
          [Extract from data/docs/copilot-chat.md]
          
          ## Keyboard Shortcuts
          [Extract from data/docs/copilot-getting-started.md]
          
          ## Complete Changelog
          [ALL changes, reverse chronological, from metadata.json doc_versions.history]
          
          ## All Videos
          [All 6 videos, categorized by topic]
          \`\`\`

          ### Output Requirements
          - **Brief**: README.md should be ~500-800 words (engineers skim fast)
          - **Actionable**: Every tip must be something engineers can try immediately
          - **Factual**: Specific features with dates, not vague \"updates available\"
          - **Linked**: Every mention links to source (blog post, doc, video)
          - **Fresh**: Focus on last 30 days, older items only if highly significant

          **Instructions file**: \`.github/copilot-instructions.md\` has full synthesis rules

          Create a PR with both files."
      
      - name: No Changes Detected
        if: steps.changes.outputs.HAS_CHANGES == 'false'
        run: echo "‚ÑπÔ∏è No changes detected. Skipping content generation."
