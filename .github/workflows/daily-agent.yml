name: Daily Copilot Digest

on:
  schedule:
    - cron: '14 23 * * *'  # Daily at 1 PM UTC
  workflow_dispatch:     # Allows manual triggering

permissions:
  contents: write        # Required to push changes
  pull-requests: write   # Required for copilot agent
  issues: write          # Required to create issues

jobs:
  fetch-and-detect:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Fetch all content sources
      - name: Fetch GitHub Docs
        run: python scraper/fetch_docs.py
      
      - name: Fetch GitHub Blog (RSS)
        run: python scraper/fetch_blog.py
      
      - name: Fetch YouTube Videos (RSS)
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: python scraper/fetch_youtube.py
      
      # Detect changes
      - name: Detect Changes
        id: changes
        run: |
          python scraper/detect_changes.py > changes.txt
          cat changes.txt
          
          # Check if there are changes
          if grep -q '"has_changes": true' data/changes-summary.json; then
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
          else
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          fi
      
      # Commit data files
      - name: Commit Data Files
        if: steps.changes.outputs.HAS_CHANGES == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git commit -m "chore: update scraped data [$(date +'%Y-%m-%d')]"
          git push
      
      # Trigger Publisher Agent (only if changes detected)
      - name: Create Issue for Publisher Agent
        if: steps.changes.outputs.HAS_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read change summary
          SUMMARY=$(cat data/changes-summary.json | jq -r '.summary_text')
          
          # Create issue for Publisher agent
          gh issue create \
            --title "üì∞ Content Update Required - $(date +'%Y-%m-%d')" \
            --body "## Changes Detected

          $SUMMARY

          ---

          @copilot Please generate updated content files from the latest scraped data.

          ### Current Data Sources
          - **Documentation**: \`data/docs/*.md\` - GitHub Copilot official docs (14+ files)
          - **Blog Posts**: \`data/blog/*.json\` - Filtered Copilot-related posts from GitHub Blog & Changelog
          - **Videos**: \`data/videos/*.json\` - Filtered Copilot/AI/Agent videos from GitHub YouTube channel
          - **Change Summary**: \`data/changes-summary.json\` - Aggregated change detection with diff information
          - **Metadata**: \`data/metadata.json\` - Content hashes, version history, and timestamps

          ### What to Generate
          1. **\`content/videos.md\`** - Video library (already auto-generated by \`generate_videos.py\`)
          2. **\`content/README.md\`** - Main digest with overview of all Copilot features and updates
          3. **\`content/changelog.md\`** - Feature timeline showing when docs changed (use \`metadata.json\` ‚Üí \`doc_versions\` ‚Üí \`history\`)
          4. **\`content/cheatsheet.md\`** - Quick reference for slash commands, variables, best practices

          ### How to Use Metadata
          - Check \`doc_versions[doc_name].history[]\` for timestamps and diff summaries
          - Look for \`changed: true\` entries with \`diff_summary\` (e.g., \"+10 lines, -5 lines\")
          - Use \`last_changed\` timestamps to show \"Updated on [date]\"

          ### Output Format
          - Use clear markdown with emojis (üìö ‚ú® üé• üìù)
          - Keep content scannable with headers and lists
          - Link to original sources
          - Highlight new features prominently

          **Assigned to:** Copilot Publisher Agent"
      
      - name: No Changes Detected
        if: steps.changes.outputs.HAS_CHANGES == 'false'
        run: echo "‚ÑπÔ∏è No changes detected. Skipping content generation."
